<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Polite Requests Game</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #scene { margin-bottom: 20px; }
    #feedback { margin-top: 10px; color: blue; }
    #result { margin-top: 10px; font-weight: bold; }
    input { width: 80%; padding: 5px; }
    button { padding: 5px 10px; }
  </style>
</head>
<body>
  <h1>Polite Requests Game</h1>
  <div id="scene">
    <p id="scene-text"></p>
    <input type="text" id="student-input" placeholder="Type your response here...">
    <button id="submit-btn">Submit</button>
    <div id="feedback"></div>
    <div id="result"></div>
  </div>

  <script>
    const scenes = [
      {
        id: "grocery",
        text: "You are at the grocery store and cannot find baking soda. An employee is stocking shelves.",
        softeners: ["excuse me","hi","sorry","pardon me"]
      },
      {
        id: "peer",
        text: "You are trying to study in your dorm, but neighbors are playing music loudly.",
        softeners: ["please","maybe","just","a little","if you don't mind"]
      },
      {
        id: "professor",
        text: "Write an email to your professor requesting help. Include greeting, request, evidence you tried, thank you, and sign-off.",
        softeners: []
      }
    ];

    let currentScene = 0;

    const sceneTextEl = document.getElementById("scene-text");
    const inputEl = document.getElementById("student-input");
    const feedbackEl = document.getElementById("feedback");
    const resultEl = document.getElementById("result");
    const submitBtn = document.getElementById("submit-btn");

    const chaosKeywords = ["NOW","STOP","SHUT UP","LEAVE","DO IT","OR ELSE","I WILL","I'M GOING TO","STUPID","IDIOT","DUMB","SCREW YOU"];

    function containsChaos(input){
      const upper = input.toUpperCase();
      if(input && input === input.toUpperCase() && /[A-Z]/.test(input)) return true;
      if(/([!?]{2,})/.test(input)) return true;
      for(const kw of chaosKeywords){ if(upper.includes(kw)) return true; }
      if(/\*.*\*|\[.*\]/.test(input)) return true;
      return false;
    }

    function checkPass(scene, input){
      const lower = input.toLowerCase();
      const feedbacks = [];
      let pass = true;

      if(containsChaos(input)){
        return {pass:false, feedback:"Chaos gremlin! Try being polite and clear.", chaos:true};
      }

      if(scene.id === "grocery"){
        if(!/could you|would you/.test(lower)){ feedbacks.push("Use 'Could you' or 'Would you'."); pass=false; }
        if(!scene.softeners.some(s => lower.includes(s))){ feedbacks.push("Add a polite attention-getting word."); pass=false; }
        const sc = scene.softeners.filter(s => lower.includes(s)).length;
        if(sc>1){ feedbacks.push("You used many polite words — employee looks puzzled but helps anyway."); }
      } else if(scene.id==="peer"){
        if(!/could you|would you/.test(lower)){ feedbacks.push("Use 'Could you' or 'Would you'."); pass=false; }
        if(!scene.softeners.some(s => lower.includes(s))){ feedbacks.push("Add a polite softener."); pass=false; }
        if(!/i['’]?m trying to|i have|i need/i.test(lower)){ feedbacks.push("Include a reason why."); pass=false; }
        const sc = scene.softeners.filter(s => lower.includes(s)).length;
        if(sc>1){ feedbacks.push("You used many polite words — neighbor looks puzzled but helps anyway."); }
      } else if(scene.id==="professor"){
        if(!/could you|would you/.test(lower)){ feedbacks.push("Make a question using 'Could you' or 'Would you'."); pass=false; }
        if(!/hi|hello|greetings|dear/i.test(input)){ feedbacks.push("Include a greeting like 'Hi' or 'Dear'."); pass=false; }
        if(!/tried|read|attempt|asked|looked at|looked for/i.test(lower)){ feedbacks.push("Show you tried first, e.g., 'I looked at the syllabus'."); pass=false; }
        if(!/thank/i.test(input)){ feedbacks.push("Include a 'Thank you'."); pass=false; }
        if(!/sincerely|best|regards/i.test(input) && !/^[\s\S]*\n.*$/.test(input)){ feedbacks.push("Include a sign-off or your name."); pass=false; }
      }

      return {pass, feedback:feedbacks.join(" "), chaos:false};
    }

    function updateScene(){
      sceneTextEl.textContent = scenes[currentScene].text;
      inputEl.value="";
      feedbackEl.textContent="";
      resultEl.textContent="";
    }

    submitBtn.addEventListener("click", ()=>{
      const input = inputEl.value.trim();
      if(!input) return;
      const scene = scenes[currentScene];
      const check = checkPass(scene,input);

      if(check.chaos){ resultEl.textContent = check.feedback; return; }
      feedbackEl.textContent = check.feedback;

      if(check.pass){
        resultEl.textContent="Success! You passed this scene.";
        currentScene++;
        if(currentScene<scenes.length){ setTimeout(updateScene,1500); }
        else{ resultEl.textContent+=" All scenes complete!"; }
      }
    });

    updateScene();
  </script>
</body>
</html>
